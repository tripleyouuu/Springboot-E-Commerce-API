<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Razorpay Checkout</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background-color: #3399cc; color: white; border: none; padding: 10px 20px; cursor: pointer; }
        button:hover { background-color: #287a9f; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Checkout</h2>
        <div class="form-group">
            <label for="orderId">Order ID:</label>
            <input type="number" id="orderId" placeholder="Enter Order ID">
        </div>
        <button onclick="initiatePayment()">Pay Now</button>
    </div>

    <script>
        async function initiatePayment() {
            const orderId = document.getElementById('orderId').value;
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }

            try {
                // 1. Fetch Razorpay Key
                const configResponse = await fetch('/api/config/razorpay');
                const config = await configResponse.json();
                const razorpayKey = config.key;

                // 2. Call backend to create payment
                const response = await fetch('/api/payments/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: parseInt(orderId) })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment');
                }

                const paymentData = await response.json();
                console.log('Payment Created:', paymentData);

                const options = {
                    "key": razorpayKey, // Fetched from backend
                    "amount": paymentData.order.totalAmount * 100,
                    "currency": "INR",
                    "name": "Ecommerce App",
                    "description": "Test Transaction",
                    "image": "https://example.com/your_logo",
                    "order_id": paymentData.razorpayOrderId, 
                    "handler": function (response){
                        alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
                        
                    },
                    "prefill": {
                        "name": paymentData.order.user.name,
                        "email": paymentData.order.user.email,
                        "contact": "9999999999"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                
                console.log("Opening Razorpay with options:", options);
                
                const rzp1 = new Razorpay(options);
                rzp1.on('payment.failed', function (response){
                        alert("Payment Failed: " + response.error.description);
                });
                rzp1.open();

            } catch (error) {
                console.error('Error:', error);
                alert('Error initiating payment: ' + error.message);
            }
        }
    </script>
</body>
</html>
